#!/bin/sh
# Version: @VERSION@
# Author: Oxnz <yunxinyi@gmail.com>
# This file is part of the @PACKAGE@ project
# Copyright (C) 2013 Oxnz <yunxinyi@gmail.com>, All rights reserved

report="./report.html"
ofile="./chart.js"

# truncate file
if [ -e $report ]; then
	: > $report
fi
cat >> $report << HTMLEND
<html>
  <head>
  	<!-- THIS FILE IS GENERATED BY RDREPORT.SH, DO NOT EDIT THIS FILE BY HAND
	-->
	  <script src="DRAWJS" type="text/javascript"></script>
  </head>
  <body onLoad="onload()">
    <div id="banner">
      <h1>RDPP</h1>
      <hr />
    </div>
    <div id="content">
        <canvas id="chart"
                height="400" width="960" style="border:1px solid #000000;">
          Your borwser does not support canvas
        </canvas>
		<div id="controlPanel">
			<input type="submit" value="Previous Day" onclick="showPrev()">
			<input type="submit" value="Next Day" onclick="showNext()">
		</div>
    </div>
    <div id="footer">
    </div>
  </body>
</html>
HTMLEND

sed -i -e "s/DRAWJS/$(printf "%s\n" $ofile | sed 's/[[\.*^$/]/\\&/g')/" $report
if [ -e $ofile ]; then
	: > $ofile
fi
find . -name "2012*.dat.js" -exec cat >> $ofile {} \;
sed -i -e 's/,);/);/' $ofile
echo "ARRAY" >> $ofile
grep new $ofile | sed 's/var //' | sed 's/ = new Array(/,/' >> $ofile
sed -i -e 's/ARRAY/var data = [/' $ofile
sed -i -e '$ s/,/];/' $ofile
echo "DAY" >> $ofile

grep new $ofile | sed 's/var data/"/' | sed 's/ = new Array(/",/' >> $ofile
sed -i -e 's/DAY/var day = [/' $ofile
sed -i -e '$ s/,/];/' $ofile

cat >> $ofile << DRAWCHART

/*
	THIS FILE IS GENERATED BY RDREPORT.SH, DO NOT EDIT THIS FILE BY HAND
*/
var index = 0;

function onload() {
	if (data.length > 0)
		show(data[index]);
}

/*
 * @cmax: mac car cound in ts minute(s).
 * @ts: time slot length in minute(s).
 * @h: height
 * @w: width
 */
Array.prototype.draw = function(ctx, ts, cmax, h, w, title) {
	ctx.fillStyle = '#FFFFFF';
	ctx.fillRect(0, 0, w, h);
	var dx = w*ts/(24*60);
	var dy = h/cmax;
	var n = 24*60/ts;
	ctx.fillStyle = '#00FF00';
	for (var i = 0; i < n; ++i) {
		ctx.fillRect(i*dx, h - dy*this[i], 2, dy*this[i]);
	}
	ctx.fillStyle = '#FF0000';
	ctx.font = '10px Arial';
	dx = w/24;
	for (var i = 0; i < 25; ++i) {
		ctx.fillRect(i*dx, 0, 1, h);
		ctx.fillText(i, i*dx+dx/3, 10);
	}
	ctx.font = '24px Arial';
	ctx.fillText(title, w/2-20, h/2);
}

function show(d) {
	d.draw(
			ctx = document.getElementById('chart').getContext('2d'),
			ts = 3,
			cmax = 20000,
			h = 400,
			w = 960,
			title = day[index]
			);
}

function showPrev() {
	if (--index >= 0)
		show(data[index]);
	else
		alert("Already the first day, index = " + index);
}

function showNext() {
	if (++index < data.length)
		show(data[index]);
	else
		alert("Already the last day, index = " + index);
}

DRAWCHART
